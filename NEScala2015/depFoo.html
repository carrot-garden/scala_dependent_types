<div class="highlight"><pre><span class="k">trait</span> <span class="nc">Foo</span><span class="o">{</span>
  <span class="k">class</span> <span class="nc">Bar</span><span class="o">(</span><span class="n">x</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span>

  <span class="k">def</span> <span class="n">use</span><span class="o">[</span><span class="kt">A</span><span class="o">](</span><span class="n">bar</span><span class="k">:</span> <span class="kt">Bar</span><span class="o">)(</span><span class="n">f</span><span class="k">:</span> <span class="kt">Bar</span> <span class="o">=&gt;</span> <span class="n">A</span><span class="o">)</span><span class="k">:</span> <span class="kt">A</span>
<span class="o">}</span>

<span class="k">val</span> <span class="n">foo</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">Foo</span><span class="o">{}</span>
<span class="k">val</span> <span class="n">fooBar</span> <span class="k">=</span> <span class="k">new</span> <span class="n">foo</span><span class="o">.</span><span class="nc">Bar</span><span class="o">(</span><span class="mi">1</span><span class="o">)</span>
<span class="k">val</span> <span class="n">oh</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">Foo</span><span class="o">{}</span>
<span class="k">val</span> <span class="n">dear</span> <span class="k">=</span> <span class="k">new</span> <span class="n">oh</span><span class="o">.</span><span class="nc">Bar</span><span class="o">(</span><span class="mi">1</span><span class="o">)</span>

<span class="k">trait</span> <span class="nc">Foo</span><span class="o">[</span><span class="kt">-T</span><span class="o">]{</span>
  <span class="k">type</span> <span class="kt">R</span>

  <span class="k">def</span> <span class="n">apply</span><span class="o">(</span><span class="n">x</span><span class="k">:</span> <span class="kt">T</span><span class="o">)</span><span class="k">:</span> <span class="kt">R</span>
<span class="o">}</span>

<span class="k">def</span> <span class="n">bar</span><span class="o">(</span><span class="n">foo</span><span class="k">:</span> <span class="kt">Foo</span><span class="o">)</span><span class="k">:</span> <span class="kt">foo.Bar</span> <span class="o">=</span> <span class="n">foo</span><span class="o">(</span><span class="mi">42</span><span class="o">)</span>

<span class="k">trait</span> <span class="nc">Foo</span><span class="o">[</span><span class="kt">-T</span>, <span class="kt">+R</span><span class="o">]{</span>
  <span class="k">def</span> <span class="n">apply</span><span class="o">(</span><span class="n">x</span><span class="k">:</span> <span class="kt">T</span><span class="o">)</span><span class="k">:</span> <span class="kt">R</span>
<span class="o">}</span>

<span class="k">trait</span> <span class="nc">Function1</span><span class="o">[</span><span class="kt">-T1</span>, <span class="kt">+R</span><span class="o">]</span> <span class="nc">extends</span> <span class="nc">AnyRef</span> <span class="o">{</span> <span class="n">self</span> <span class="k">=&gt;</span>

  <span class="k">def</span> <span class="n">apply</span><span class="o">(</span><span class="n">v1</span><span class="k">:</span> <span class="kt">T1</span><span class="o">)</span><span class="k">:</span> <span class="kt">R</span>

  <span class="k">def</span> <span class="n">andThen</span><span class="o">[</span><span class="kt">A</span><span class="o">](</span><span class="n">g</span><span class="k">:</span> <span class="kt">R</span> <span class="o">=&gt;</span> <span class="n">A</span><span class="o">)</span><span class="k">:</span> <span class="kt">T1</span> <span class="o">=&gt;</span> <span class="n">A</span> <span class="k">=</span> <span class="o">{</span> <span class="n">x</span> <span class="k">=&gt;</span> <span class="n">g</span><span class="o">(</span><span class="n">apply</span><span class="o">(</span><span class="n">x</span><span class="o">))</span> <span class="o">}</span>

  <span class="k">def</span> <span class="n">compose</span><span class="o">[</span><span class="kt">A</span><span class="o">](</span><span class="n">g</span><span class="k">:</span> <span class="kt">A</span> <span class="o">=&gt;</span> <span class="n">T1</span><span class="o">)</span><span class="k">:</span> <span class="kt">A</span> <span class="o">=&gt;</span> <span class="n">R</span> <span class="k">=</span> <span class="n">g</span> <span class="n">andThen</span> <span class="n">self</span>

  <span class="k">override</span> <span class="k">def</span> <span class="n">toString</span><span class="o">()</span> <span class="k">=</span> <span class="s">&quot;&lt;function1&gt;&quot;</span>
<span class="o">}</span>

<span class="k">trait</span> <span class="nc">DepFun1</span><span class="o">[</span><span class="kt">-T</span><span class="o">]</span> <span class="o">{</span> <span class="n">self</span> <span class="k">=&gt;</span>
  <span class="k">type</span> <span class="kt">R</span>

  <span class="k">def</span> <span class="n">apply</span><span class="o">(</span><span class="n">x</span><span class="k">:</span> <span class="kt">T</span><span class="o">)</span><span class="k">:</span> <span class="kt">R</span>
<span class="o">}</span>

<span class="k">def</span> <span class="n">andThen</span><span class="o">[</span><span class="kt">A</span><span class="o">](</span><span class="n">g</span><span class="k">:</span> <span class="kt">R</span> <span class="o">=&gt;</span> <span class="n">A</span><span class="o">)</span><span class="k">:</span> <span class="kt">T1</span> <span class="o">=&gt;</span> <span class="n">A</span> <span class="k">=</span> <span class="o">{</span> <span class="n">x</span> <span class="k">=&gt;</span> <span class="n">g</span><span class="o">(</span><span class="n">apply</span><span class="o">(</span><span class="n">x</span><span class="o">))</span> <span class="o">}</span>

<span class="k">def</span> <span class="n">andThen</span><span class="o">(</span><span class="n">dep</span><span class="k">:</span> <span class="kt">DepFun1</span><span class="o">[</span><span class="kt">R</span><span class="o">])</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">DepFun1</span><span class="o">[</span><span class="kt">T</span><span class="o">]</span> <span class="o">{</span>
  <span class="k">type</span> <span class="kt">R</span> <span class="o">=</span> <span class="n">dep</span><span class="o">.</span><span class="n">R</span>

  <span class="k">def</span> <span class="n">apply</span><span class="o">(</span><span class="n">x</span><span class="k">:</span> <span class="kt">T</span><span class="o">)</span><span class="k">:</span> <span class="kt">R</span> <span class="o">=</span> <span class="n">dep</span><span class="o">(</span><span class="n">self</span><span class="o">(</span><span class="n">x</span><span class="o">))</span>
<span class="o">}</span>

<span class="k">trait</span> <span class="nc">DepFun1</span><span class="o">[</span><span class="kt">-T</span><span class="o">]{</span> <span class="n">self</span> <span class="k">=&gt;</span>
  <span class="k">type</span> <span class="kt">R</span>

  <span class="k">def</span> <span class="n">andThen</span><span class="o">(</span><span class="n">dep</span><span class="k">:</span> <span class="kt">DepFun1</span><span class="o">[</span><span class="kt">R</span><span class="o">])</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">DepFun1</span><span class="o">[</span><span class="kt">T</span><span class="o">]</span> <span class="o">{</span>
    <span class="k">type</span> <span class="kt">R</span> <span class="o">=</span> <span class="n">dep</span><span class="o">.</span><span class="n">R</span>

    <span class="k">def</span> <span class="n">apply</span><span class="o">(</span><span class="n">x</span><span class="k">:</span> <span class="kt">T</span><span class="o">)</span><span class="k">:</span> <span class="kt">R</span> <span class="o">=</span> <span class="n">dep</span><span class="o">(</span><span class="n">self</span><span class="o">(</span><span class="n">x</span><span class="o">))</span>
  <span class="o">}</span>

  <span class="k">def</span> <span class="n">compose</span><span class="o">[</span><span class="kt">A</span><span class="o">](</span><span class="n">dep</span><span class="k">:</span> <span class="kt">DepFun1</span><span class="o">[</span><span class="kt">A</span><span class="o">])</span> <span class="k">=</span> <span class="o">???</span>

  <span class="k">def</span> <span class="n">apply</span><span class="o">(</span><span class="n">x</span><span class="k">:</span> <span class="kt">T</span><span class="o">)</span><span class="k">:</span> <span class="kt">R</span>
<span class="o">}</span>

<span class="k">def</span> <span class="n">compose</span><span class="o">[</span><span class="kt">A</span><span class="o">](</span><span class="n">g</span><span class="k">:</span> <span class="kt">A</span> <span class="o">=&gt;</span> <span class="n">T1</span><span class="o">)</span><span class="k">:</span> <span class="kt">A</span> <span class="o">=&gt;</span> <span class="n">R</span> <span class="k">=</span> <span class="o">{</span> <span class="n">x</span> <span class="k">=&gt;</span> <span class="n">apply</span><span class="o">(</span><span class="n">g</span><span class="o">(</span><span class="n">x</span><span class="o">))</span> <span class="o">}</span>

<span class="k">def</span> <span class="n">compose</span><span class="o">[</span><span class="kt">A</span><span class="o">](</span><span class="n">dep</span><span class="k">:</span> <span class="kt">DepFun1</span><span class="o">[</span><span class="kt">A</span><span class="o">])(</span><span class="k">implicit</span> <span class="n">ev</span><span class="k">:</span> <span class="kt">dep.R</span> <span class="k">&lt;:</span><span class="kt">&lt;</span> <span class="kt">T</span><span class="o">)</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">DepFun1</span><span class="o">[</span><span class="kt">A</span><span class="o">]{</span>
  <span class="k">type</span> <span class="kt">R</span> <span class="o">=</span> <span class="n">self</span><span class="o">.</span><span class="n">R</span>

  <span class="k">def</span> <span class="n">apply</span><span class="o">(</span><span class="n">x</span><span class="k">:</span> <span class="kt">A</span><span class="o">)</span><span class="k">:</span> <span class="kt">R</span> <span class="o">=</span> <span class="n">self</span><span class="o">(</span><span class="n">ev</span><span class="o">(</span><span class="n">dep</span><span class="o">(</span><span class="n">x</span><span class="o">)))</span>
 <span class="o">}</span>

<span class="k">trait</span> <span class="nc">DepFun1</span><span class="o">[</span><span class="kt">-T</span><span class="o">]</span> <span class="o">{</span> <span class="n">self</span> <span class="k">=&gt;</span>
  <span class="k">type</span> <span class="kt">R</span>

  <span class="k">def</span> <span class="n">andThen</span><span class="o">(</span><span class="n">dep</span><span class="k">:</span> <span class="kt">DepFun1</span><span class="o">[</span><span class="kt">R</span><span class="o">])</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">DepFun1</span><span class="o">[</span><span class="kt">T</span><span class="o">]</span> <span class="o">{</span>
    <span class="k">type</span> <span class="kt">R</span> <span class="o">=</span> <span class="n">dep</span><span class="o">.</span><span class="n">R</span>

    <span class="k">def</span> <span class="n">apply</span><span class="o">(</span><span class="n">x</span><span class="k">:</span> <span class="kt">T</span><span class="o">)</span><span class="k">:</span> <span class="kt">R</span> <span class="o">=</span> <span class="n">dep</span><span class="o">(</span><span class="n">self</span><span class="o">(</span><span class="n">x</span><span class="o">))</span>
  <span class="o">}</span>

  <span class="k">def</span> <span class="n">compose</span><span class="o">[</span><span class="kt">A</span><span class="o">](</span><span class="n">dep</span><span class="k">:</span> <span class="kt">DepFun1</span><span class="o">[</span><span class="kt">A</span><span class="o">])(</span><span class="k">implicit</span> <span class="n">ev</span><span class="k">:</span> <span class="kt">dep.R</span> <span class="k">&lt;:</span><span class="kt">&lt;</span> <span class="kt">T</span><span class="o">)</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">DepFun1</span><span class="o">[</span><span class="kt">A</span><span class="o">]{</span>
  	<span class="k">type</span> <span class="kt">R</span> <span class="o">=</span> <span class="n">self</span><span class="o">.</span><span class="n">R</span>

  	<span class="k">def</span> <span class="n">apply</span><span class="o">(</span><span class="n">x</span><span class="k">:</span> <span class="kt">A</span><span class="o">)</span><span class="k">:</span> <span class="kt">R</span> <span class="o">=</span> <span class="n">self</span><span class="o">(</span><span class="n">ev</span><span class="o">(</span><span class="n">dep</span><span class="o">(</span><span class="n">x</span><span class="o">)))</span>
  <span class="o">}</span>

  <span class="k">def</span> <span class="n">apply</span><span class="o">(</span><span class="n">x</span><span class="k">:</span> <span class="kt">T</span><span class="o">)</span><span class="k">:</span> <span class="kt">R</span>
<span class="o">}</span>

<span class="c1">//type guards and converters</span>

<span class="k">package</span> <span class="nn">scala.collection.generic</span>

<span class="k">trait</span> <span class="nc">IsTraversableOnce</span><span class="o">[</span><span class="kt">Repr</span><span class="o">]{</span>
  <span class="k">type</span> <span class="kt">A</span>
  <span class="k">val</span> <span class="n">conversion</span><span class="k">:</span> <span class="kt">Repr</span> <span class="o">=&gt;</span> <span class="nc">GenTraversableOnce</span><span class="o">[</span><span class="kt">A</span><span class="o">]</span>
<span class="o">}</span>

<span class="k">trait</span> <span class="nc">IsTraversableLike</span><span class="o">[</span><span class="kt">Repr</span><span class="o">]{</span>
  <span class="k">type</span> <span class="kt">A</span>
  <span class="k">def</span> <span class="n">conversion</span><span class="o">(</span><span class="n">repr</span><span class="k">:</span> <span class="kt">Repr</span><span class="o">)</span><span class="k">:</span> <span class="kt">GenTraversableLike</span><span class="o">[</span><span class="kt">A</span>, <span class="kt">Repr</span><span class="o">]</span>
<span class="o">}</span>

<span class="k">trait</span> <span class="nc">IsTraversableLike</span><span class="o">[</span><span class="kt">Repr</span>, <span class="kt">A</span><span class="o">]{</span>
  <span class="k">def</span> <span class="n">conversion</span><span class="o">(</span><span class="n">repr</span><span class="k">:</span> <span class="kt">Repr</span><span class="o">)</span><span class="k">:</span> <span class="kt">GenTraversableLike</span><span class="o">[</span><span class="kt">A</span>, <span class="kt">Repr</span><span class="o">]</span>
<span class="o">}</span>

<span class="k">class</span> <span class="nc">Foo</span><span class="o">[</span><span class="kt">T</span><span class="o">](</span><span class="n">x</span><span class="k">:</span> <span class="kt">T</span><span class="o">){</span>
  <span class="k">def</span> <span class="n">magnitude</span><span class="o">[</span><span class="kt">A</span><span class="o">](</span><span class="k">implicit</span> <span class="n">itl</span><span class="k">:</span> <span class="kt">IsTraversableLike</span><span class="o">[</span><span class="kt">T</span>, <span class="kt">A</span><span class="o">])</span> <span class="k">=</span> <span class="n">itl</span><span class="o">(</span><span class="n">x</span><span class="o">).</span><span class="n">size</span>
<span class="o">}</span>

<span class="k">trait</span> <span class="nc">IsFuture</span><span class="o">[</span><span class="kt">FA</span><span class="o">]{</span>
  <span class="k">type</span> <span class="kt">A</span>

  <span class="k">def</span> <span class="n">from</span><span class="o">(</span><span class="n">ma</span><span class="k">:</span> <span class="kt">FA</span><span class="o">)</span><span class="k">:</span> <span class="kt">Future</span><span class="o">[</span><span class="kt">A</span><span class="o">]</span>
  <span class="k">def</span> <span class="n">to</span><span class="o">(</span><span class="n">ma</span><span class="k">:</span> <span class="kt">Future</span><span class="o">[</span><span class="kt">A</span><span class="o">])</span><span class="k">:</span> <span class="kt">FA</span>
<span class="o">}</span>

<span class="c1">//lalalalala</span>

<span class="k">trait</span> <span class="nc">Cont</span><span class="o">[</span><span class="kt">+T</span>, <span class="kt">R</span><span class="o">]{</span> <span class="n">self</span> <span class="k">=&gt;</span>
  <span class="k">def</span> <span class="n">apply</span><span class="o">(</span><span class="n">f</span><span class="k">:</span> <span class="kt">T</span> <span class="o">=&gt;</span> <span class="n">R</span><span class="o">)</span><span class="k">:</span> <span class="kt">R</span>

  <span class="k">def</span> <span class="n">map</span><span class="o">[</span><span class="kt">B</span><span class="o">](</span><span class="n">f</span><span class="k">:</span> <span class="kt">T</span> <span class="o">=&gt;</span> <span class="n">B</span><span class="o">)</span><span class="k">:</span> <span class="kt">Cont</span><span class="o">[</span><span class="kt">B</span>, <span class="kt">R</span><span class="o">]</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">Cont</span><span class="o">[</span><span class="kt">B</span>, <span class="kt">R</span><span class="o">]{</span>
    <span class="k">def</span> <span class="n">apply</span><span class="o">(</span><span class="n">g</span><span class="k">:</span> <span class="kt">B</span> <span class="o">=&gt;</span> <span class="n">R</span><span class="o">)</span><span class="k">:</span> <span class="kt">R</span> <span class="o">=</span> <span class="n">self</span><span class="o">(</span><span class="n">f</span> <span class="n">andThen</span> <span class="n">g</span><span class="o">)</span>
  <span class="o">}</span>

  <span class="k">def</span> <span class="n">flatMap</span><span class="o">[</span><span class="kt">B</span><span class="o">](</span><span class="n">f</span><span class="k">:</span> <span class="kt">T</span> <span class="o">=&gt;</span> <span class="nc">Cont</span><span class="o">[</span><span class="kt">B</span>, <span class="kt">R</span><span class="o">])</span><span class="k">:</span> <span class="kt">Cont</span><span class="o">[</span><span class="kt">B</span>, <span class="kt">R</span><span class="o">]</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">Cont</span><span class="o">[</span><span class="kt">B</span>, <span class="kt">R</span><span class="o">]</span> <span class="o">{</span>
    <span class="k">def</span> <span class="n">apply</span><span class="o">(</span><span class="n">g</span><span class="k">:</span> <span class="kt">B</span> <span class="o">=&gt;</span> <span class="n">R</span><span class="o">)</span><span class="k">:</span> <span class="kt">R</span> <span class="o">=</span> <span class="n">self</span><span class="o">(</span><span class="n">f</span><span class="o">(</span><span class="k">_</span><span class="o">)(</span><span class="n">g</span><span class="o">))</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="k">trait</span> <span class="nc">DepCont</span><span class="o">[</span><span class="kt">+T</span><span class="o">]</span> <span class="o">{</span> <span class="n">self</span> <span class="k">=&gt;</span>
  <span class="k">def</span> <span class="n">apply</span><span class="o">(</span><span class="n">dep</span><span class="k">:</span> <span class="kt">DepFun1</span><span class="o">[</span><span class="kt">T</span><span class="o">])</span><span class="k">:</span> <span class="kt">dep.R</span>

  <span class="k">def</span> <span class="n">map</span><span class="o">(</span><span class="n">f</span><span class="k">:</span> <span class="kt">DepFun1</span><span class="o">[</span><span class="kt">T</span><span class="o">])</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">DepCont</span><span class="o">[</span><span class="kt">f.R</span><span class="o">]</span> <span class="o">{</span>
    <span class="k">def</span> <span class="n">apply</span><span class="o">(</span><span class="n">dep</span><span class="k">:</span> <span class="kt">DepFun1</span><span class="o">[</span><span class="kt">f.R</span><span class="o">])</span><span class="k">:</span> <span class="kt">dep.R</span> <span class="o">=</span> <span class="n">self</span><span class="o">(</span><span class="n">f</span> <span class="n">andThen</span> <span class="n">dep</span><span class="o">)</span>
  <span class="o">}</span>

  <span class="k">def</span> <span class="n">flatMap</span><span class="o">(</span><span class="n">f</span><span class="k">:</span> <span class="kt">DepFun1</span><span class="o">[</span><span class="kt">T</span><span class="o">])(</span><span class="k">implicit</span> <span class="n">ids</span><span class="k">:</span> <span class="kt">IsDepCont</span><span class="o">[</span><span class="kt">f.R</span><span class="o">])</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">DepCont</span><span class="o">[</span><span class="kt">ids.R</span><span class="o">]</span> <span class="o">{</span>
    <span class="k">def</span> <span class="n">apply</span><span class="o">(</span><span class="n">g</span><span class="k">:</span> <span class="kt">DepFun1</span><span class="o">[</span><span class="kt">ids.R</span><span class="o">])</span><span class="k">:</span> <span class="kt">g.R</span> <span class="o">=</span> <span class="n">self</span><span class="o">(</span><span class="k">new</span> <span class="nc">DepFun1</span><span class="o">[</span><span class="kt">T</span><span class="o">]</span> <span class="o">{</span>
      <span class="k">type</span> <span class="kt">R</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">R</span>

      <span class="k">def</span> <span class="n">apply</span><span class="o">(</span><span class="n">x</span><span class="k">:</span> <span class="kt">T</span><span class="o">)</span> <span class="k">=</span> <span class="n">ids</span><span class="o">(</span><span class="n">f</span><span class="o">(</span><span class="n">x</span><span class="o">))(</span><span class="n">g</span><span class="o">)</span>
    <span class="o">})</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="c1">//signatures</span>

<span class="k">def</span> <span class="n">map</span><span class="o">(</span><span class="n">f</span><span class="k">:</span> <span class="kt">DepFun1</span><span class="o">[</span><span class="kt">T</span><span class="o">])(</span><span class="k">implicit</span> <span class="n">tie</span><span class="k">:</span> <span class="kt">Tie</span><span class="o">[</span><span class="kt">f.R</span><span class="o">])</span><span class="k">:</span> <span class="kt">M</span><span class="o">[</span><span class="kt">tie.In</span><span class="o">]</span>

<span class="k">def</span> <span class="n">flatMap</span><span class="o">(</span><span class="n">f</span><span class="k">:</span> <span class="kt">DepFun1</span><span class="o">[</span><span class="kt">T</span><span class="o">])(</span><span class="k">implicit</span> <span class="n">tie</span><span class="k">:</span> <span class="kt">Tie</span><span class="o">[</span><span class="kt">f.R</span><span class="o">])</span><span class="k">:</span> <span class="kt">M</span><span class="o">[</span><span class="kt">tie.In</span><span class="o">]</span>

<span class="c1">//dmap</span>

<span class="k">trait</span> <span class="nc">DepCont</span><span class="o">[</span><span class="kt">T</span><span class="o">]</span> <span class="o">{</span> <span class="n">self</span> <span class="k">=&gt;</span>
  <span class="k">def</span> <span class="n">apply</span><span class="o">(</span><span class="n">dep</span><span class="k">:</span> <span class="kt">DepFun1</span><span class="o">[</span><span class="kt">T</span><span class="o">])</span><span class="k">:</span> <span class="kt">dep.R</span>

  <span class="k">def</span> <span class="n">map</span><span class="o">(</span><span class="n">f</span><span class="k">:</span> <span class="kt">DepFun1</span><span class="o">[</span><span class="kt">T</span><span class="o">])(</span><span class="k">implicit</span> <span class="n">tie</span><span class="k">:</span> <span class="kt">Tie</span><span class="o">[</span><span class="kt">f.R</span><span class="o">])</span> <span class="k">=</span> <span class="n">dmap</span><span class="o">(</span><span class="n">f</span><span class="o">)(</span><span class="n">tie</span><span class="o">)</span>

  <span class="k">def</span> <span class="n">flatMap</span><span class="o">(</span><span class="n">f</span><span class="k">:</span> <span class="kt">DepFun1</span><span class="o">[</span><span class="kt">T</span><span class="o">])(</span><span class="k">implicit</span> <span class="n">tie</span><span class="k">:</span> <span class="kt">Tie</span><span class="o">[</span><span class="kt">f.R</span><span class="o">])</span> <span class="k">=</span> <span class="n">dmap</span><span class="o">(</span><span class="n">f</span><span class="o">)(</span><span class="n">tie</span><span class="o">)</span>

  <span class="k">def</span> <span class="n">dmap</span><span class="o">(</span><span class="n">f</span><span class="k">:</span> <span class="kt">DepFun1</span><span class="o">[</span><span class="kt">T</span><span class="o">])(</span><span class="k">implicit</span> <span class="n">tie</span><span class="k">:</span> <span class="kt">Tie</span><span class="o">[</span><span class="kt">f.R</span><span class="o">])</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">DepCont</span><span class="o">[</span><span class="kt">tie.In</span><span class="o">]{</span>
    <span class="k">def</span> <span class="n">apply</span><span class="o">(</span><span class="n">dep</span><span class="k">:</span> <span class="kt">DepFun1</span><span class="o">[</span><span class="kt">tie.In</span><span class="o">])</span><span class="k">:</span> <span class="kt">dep.R</span> <span class="o">=</span> <span class="n">self</span><span class="o">(</span><span class="k">new</span> <span class="nc">DepFun1</span><span class="o">[</span><span class="kt">T</span><span class="o">]{</span>
      <span class="k">type</span> <span class="kt">R</span> <span class="o">=</span> <span class="n">dep</span><span class="o">.</span><span class="n">R</span>

      <span class="k">def</span> <span class="n">apply</span><span class="o">(</span><span class="n">x</span><span class="k">:</span> <span class="kt">T</span><span class="o">)</span> <span class="k">=</span> <span class="n">tie</span><span class="o">(</span><span class="n">f</span><span class="o">(</span><span class="n">x</span><span class="o">),</span> <span class="n">dep</span><span class="o">)</span>
    <span class="o">})</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="k">trait</span> <span class="nc">Tie</span><span class="o">[</span><span class="kt">R</span><span class="o">]{</span>
  <span class="k">type</span> <span class="kt">In</span>

  <span class="k">def</span> <span class="n">apply</span><span class="o">(</span><span class="n">r</span><span class="k">:</span> <span class="kt">R</span><span class="o">,</span> <span class="n">f</span><span class="k">:</span> <span class="kt">DepFun1</span><span class="o">[</span><span class="kt">In</span><span class="o">])</span><span class="k">:</span> <span class="kt">f.R</span>
<span class="o">}</span>

<span class="k">object</span> <span class="nc">Tie</span> <span class="k">extends</span> <span class="nc">LowPriorityTie</span><span class="o">{</span>
  <span class="k">def</span> <span class="n">apply</span><span class="o">[</span><span class="kt">R</span><span class="o">](</span><span class="k">implicit</span> <span class="n">tie</span><span class="k">:</span> <span class="kt">Tie</span><span class="o">[</span><span class="kt">R</span><span class="o">])</span><span class="k">:</span> <span class="kt">Aux</span><span class="o">[</span><span class="kt">R</span>, <span class="kt">tie.In</span><span class="o">]</span> <span class="k">=</span> <span class="n">tie</span>

  <span class="k">implicit</span> <span class="k">def</span> <span class="n">tieFM</span><span class="o">[</span><span class="kt">R</span><span class="o">]</span><span class="k">:</span> <span class="kt">Aux</span><span class="o">[</span><span class="kt">DepCont</span><span class="o">[</span><span class="kt">R</span><span class="o">]</span>, <span class="kt">R</span><span class="o">]</span> <span class="k">=</span>
    <span class="k">new</span> <span class="nc">Tie</span><span class="o">[</span><span class="kt">DepCont</span><span class="o">[</span><span class="kt">R</span><span class="o">]]{</span>
      <span class="k">type</span> <span class="kt">In</span> <span class="o">=</span> <span class="n">R</span>

      <span class="k">def</span> <span class="n">apply</span><span class="o">(</span><span class="n">r</span><span class="k">:</span> <span class="kt">DepCont</span><span class="o">[</span><span class="kt">R</span><span class="o">],</span> <span class="n">f</span><span class="k">:</span> <span class="kt">DepFun1</span><span class="o">[</span><span class="kt">R</span><span class="o">])</span><span class="k">:</span> <span class="kt">f.R</span> <span class="o">=</span> <span class="n">r</span><span class="o">(</span><span class="n">f</span><span class="o">)</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="k">trait</span> <span class="nc">LowPriorityTie</span><span class="o">{</span>
  <span class="k">type</span> <span class="kt">Aux</span><span class="o">[</span><span class="kt">R</span>, <span class="kt">In0</span><span class="o">]</span> <span class="k">=</span> <span class="nc">Tie</span><span class="o">[</span><span class="kt">R</span><span class="o">]{</span> <span class="k">type</span> <span class="kt">In</span> <span class="o">=</span> <span class="nc">In0</span> <span class="o">}</span>

  <span class="k">implicit</span> <span class="k">def</span> <span class="n">tieF</span><span class="o">[</span><span class="kt">R</span><span class="o">]</span><span class="k">:</span> <span class="kt">Aux</span><span class="o">[</span><span class="kt">R</span>, <span class="kt">R</span><span class="o">]</span> <span class="k">=</span>
    <span class="k">new</span> <span class="nc">Tie</span><span class="o">[</span><span class="kt">R</span><span class="o">]{</span>
      <span class="k">type</span> <span class="kt">In</span> <span class="o">=</span> <span class="n">R</span>

      <span class="k">def</span> <span class="n">apply</span><span class="o">(</span><span class="n">r</span><span class="k">:</span> <span class="kt">R</span><span class="o">,</span> <span class="n">f</span><span class="k">:</span> <span class="kt">DepFun1</span><span class="o">[</span><span class="kt">R</span><span class="o">])</span><span class="k">:</span> <span class="kt">f.R</span> <span class="o">=</span> <span class="n">f</span><span class="o">(</span><span class="n">r</span><span class="o">)</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="c1">//reasoning</span>

<span class="nc">List</span><span class="o">[</span><span class="kt">List</span><span class="o">[</span><span class="kt">A</span><span class="o">]]</span>

<span class="nc">List</span><span class="o">[</span><span class="kt">List</span><span class="o">[</span><span class="kt">List</span><span class="o">[</span><span class="kt">List</span><span class="o">[</span><span class="kt">A</span><span class="o">]]]]</span>

<span class="nc">StateMonad</span><span class="o">[</span><span class="kt">S</span>, <span class="kt">A</span><span class="o">]</span>

<span class="nc">StateMonad</span><span class="o">[</span><span class="kt">S1</span>, <span class="kt">StateMonad</span><span class="o">[</span><span class="kt">S2</span>, <span class="kt">StateMonad</span><span class="o">[</span><span class="kt">S3</span>, <span class="kt">StateMonad</span><span class="o">[</span><span class="kt">S4</span>, <span class="kt">A</span><span class="o">]]]]</span>
</pre></div>
